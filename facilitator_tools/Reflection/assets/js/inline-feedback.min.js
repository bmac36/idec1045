function submitInit(){$("#feedbacksubmit").click(function(){$("#feedbacksubmit").unbind("click"),$("#feedbacksubmit").addClass("disabled");var e,s,t,a;if(a=parseInt($("#feedbackcat option:selected").attr("data-topid")),a>-1&&(DiscussTopID=a),$("#feedbacktext").val().length>0){t=$("#suggestionanon").prop("checked"),e={ParentPostId:null,Subject:"Response",Message:{Content:$("#feedbacktext").val(),Type:"Text"},IsAnonymous:!1},s={Subject:"Response",Message:{Content:$("#feedbacktext").val(),Type:"Text"}};for(var o=-1,c=0;c<FeedbackOptions.length;c++)DiscussForID===FeedbackOptions[c].ForumId&&DiscussTopID===FeedbackOptions[c].TopicId&&FeedbackOptions[c].MyPosts.length>0&&(FeedbackOptions[c].MyPosts[0].Message.Text=$("#feedbacktext").val(),o=FeedbackOptions[c].MyPosts[0].PostId);o>-1?CSVal.update_post(DiscussForID,DiscussTopID,o,s):CSVal.post_post(DiscussForID,DiscussTopID,e)}else submitInit(),$("#feedbacksubmit").removeClass("disabled")})}function populateFeedback(e){if(null===e)FeedbackOptions[0].MyPosts.length>0&&$("#feedbacktext").val(FeedbackOptions[0].MyPosts[0].Message.Html.replace(/(<([^>]+)>)/gi,""));else{for(var s=-1,t=0;t<FeedbackOptions.length;t++)FeedbackOptions[t].TopicId===e&&(s=t);s>-1&&FeedbackOptions[s].MyPosts.length>0?(""!==FeedbackOptions[s].MyPosts[0].Message.Text?$("#feedbacktext").val(FeedbackOptions[s].MyPosts[0].Message.Text):$("#feedbacktext").val(FeedbackOptions[s].MyPosts[0].Message.Html.replace(/(<([^>]+)>)/gi,"")),null!==FeedbackOptions[s].MyPosts[0].LastEditDate?$("#feedbackconfirm").html("Saved: "+processDate(FeedbackOptions[s].MyPosts[0].LastEditDate)):$("#feedbackconfirm").html("Saved: "+processDate(FeedbackOptions[s].MyPosts[0].DatePosted))):$("#feedbacktext").val("")}}function processDate(e){var s=[];s[0]="Sun",s[1]="Mon",s[2]="Tue",s[3]="Wed",s[4]="Thu",s[5]="Fri",s[6]="Sat";var t=[];t[0]="January",t[1]="February",t[2]="March",t[3]="April",t[4]="May",t[5]="June",t[6]="July",t[7]="August",t[8]="September",t[9]="October",t[10]="November",t[11]="December";var a=new Date(e),o=s[a.getDay()],c=t[a.getMonth()],i=a.getDate(),d=a.getFullYear(),n=a.getMinutes();10>n&&(n="0"+n);var l,r;a.getHours()>11?(l=a.getHours()-12,0===l&&(l=12),r="pm"):(l=a.getHours(),r="am"),0===l&&(l=12);var p=o+" "+c+" "+i+", "+d+" | "+l+":"+n+r;return p}var CSVal,pubsubz,valence_req,valence_auth,errorPrompt,DiscTitle="Personal Reflections",DiscussForID=-1,DiscussTopID=-1,FeedbackOptions=[],FeedbackSelected=-1,numTopicPostsChecked=0;CSVal.post_post=function(e,s,t){var a=CSVal.routes.post_post;a=a.replace("ORGID",CSVal.context.ouID),a=a.replace("TOPICID",s),a=a.replace("FORUMID",e),valence_req.post(a).send(t).use(valence_auth).end(function(t,o){if(null!==t)return errorPrompt(t,a,"alert"),!1;for(var c=0;c<FeedbackOptions.length;c++)e===FeedbackOptions[c].ForumId&&s===FeedbackOptions[c].TopicId&&FeedbackOptions[c].MyPosts.push(o.body);setTimeout(function(){$("#feedbackconfirm").html("Saved: "+processDate(o.body.DatePosted)),submitInit(),$("#feedbacksubmit").removeClass("disabled")},2e3)})},CSVal.update_post=function(e,s,t,a){var o=CSVal.routes.update_post;o=o.replace("ORGID",CSVal.context.ouID),o=o.replace("TOPICID",s),o=o.replace("FORUMID",e),o=o.replace("POSTID",t),valence_req.put(o).send(a).use(valence_auth).end(function(e){return null!==e?(errorPrompt(e,o,"alert"),!1):void setTimeout(function(){var e=new Date;$("#feedbackconfirm").html("Saved: "+processDate(e)),submitInit(),$("#feedbacksubmit").removeClass("disabled")},2e3)})},pubsubz.subscribe("csval/init",function(){""!==DiscTitle?CSVal.get_forums():$("#inlinefeedback").css("display","block")}),pubsubz.subscribe("csval/get_topics",function(){for(var e=-1,s=-1,t=0;t<CSVal.disc.Forums.length;t++)if(CSVal.disc.Forums[t].Name===DiscTitle){e=t,DiscussForID=CSVal.disc.Forums[t].ForumId;for(var a=0;a<CSVal.disc.Forums[t].Topics.length;a++)if(CSVal.disc.Forums[t].Topics[a].Name===window.parent.$(".d2l-page-header .d2l-page-title").text()){s=a,pubsubz.subscribe("csval/get_posts/"+DiscussForID+"/"+CSVal.disc.Forums[t].Topics[a].TopicId,function(e){numTopicPostsChecked+=1;for(var s=[],t=0;t<e.PostsObj.length;t++)CSVal.user.Identifier!==String(e.PostsObj[t].PostingUserId)||e.PostsObj[t].IsDeleted||s.push(e.PostsObj[t]);for(var a=0;a<FeedbackOptions.length;a++)FeedbackOptions[a].ForumId===e.ForumId&&FeedbackOptions[a].TopicId===e.TopicId&&(FeedbackOptions[a].MyPosts=s);populateFeedback(FeedbackSelected)}),CSVal.get_posts(DiscussForID,CSVal.disc.Forums[t].Topics[a].TopicId),-1===FeedbackSelected&&(FeedbackSelected=CSVal.disc.Forums[t].Topics[a].TopicId);var o={ForumId:DiscussForID,TopicId:CSVal.disc.Forums[t].Topics[a].TopicId,MyPosts:[]};FeedbackOptions.push(o),$("#feedbackcat").append('<option data-topid="'+CSVal.disc.Forums[t].Topics[a].TopicId+'">'+CSVal.disc.Forums[t].Topics[a].Name+"</option>")}}e>-1&&s>-1?($("#feedbackcat").css("display","none"),$("#feedbacktitle").html(DiscTitle),$("#discdesc").html(CSVal.disc.Forums[e].Description.Html+CSVal.disc.Forums[e].Topics[s].Description.Html),$("#inlinefeedback").css("display","block"),submitInit()):$("#inlinefeedback").css("display","none")}),$("#feedbackcat").change(function(){FeedbackSelected=parseInt($("#feedbackcat option:selected").attr("data-topid")),populateFeedback(FeedbackSelected)}),CSVal.init();